<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document</title>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .fade-in {
            animation: .3s forwards fadeIn;
        }

        .fade-out {
            animation: .3s forwards fadeOut;
        }

        [data-drop] {
            display: none;
        }
    </style>
</head>
<body>
<ul data-droppy='{"wrapper":"[data-wrapper]","trigger":"[data-trigger]","drop":"[data-drop]","animationIn":"fade-in","animationOut":"fade-out","display":"block","clickAwayToClose":true}'>
    <li data-wrapper="">
        <span data-trigger="" tabindex="0">Primo</span>
        <ul data-drop="">
            <li data-wrapper="">
                <span data-trigger="">#1 - Primo</span>
                <ul data-drop="">
                    <li><span>#2 - Primo</span></li>
                    <li><span>#2 - Secondo</span></li>
                    <li><span>#2 - Terzo</span></li>
                </ul>
            </li>
            <li><span>#1 - Secondo</span></li>
            <li><span>#1 - Terzo</span></li>
        </ul>
    </li>
    <li data-wrapper="">
        <span data-trigger="">Secondo</span>
        <ul data-drop="">
            <li><span>#1 - Primo</span></li>
            <li><span>#1 - Secondo</span></li>
            <li><span>#1 - Terzo</span></li>
        </ul>
    </li>
    <li><span>Terzo</span></li>
</ul>

<script>
    'use strict';

    /**
     * @typedef {Object} DroppyOptions
     * @prop {string} animationIn
     * @prop {string} animationOut
     * @prop {string} display
     * @prop {boolean} clickAwayToClose
     */

    /** @type DroppyOptions */
    const defaultOptions = {
        animationIn: '',
        animationOut: '',
        display: 'block',
        clickAwayToClose: true,
    }

    /** @type Droppy[] */
    const droppies = [];

    document.body.addEventListener('click', (event) => {
        for (const droppy of droppies) {
            if (droppy.trigger !== event.target
                && droppy.drop.checkVisibility()
                && ! droppy.drop.contains(event.target)) droppy.hide();
        }
    });

    class Droppy {
        /** @type {HTMLElement} */
        trigger;
        /** @type {HTMLElement} */
        drop;
        /** @type {DroppyOptions} */
        options;

        /**
         * @param {HTMLElement} trigger
         * @param {HTMLElement} drop
         * @param {DroppyOptions} options
         */
        constructor(trigger, drop, options) {
            this.trigger = trigger;

            this.trigger.addEventListener('click', () => this.toggle());

            this.drop = drop;

            this.options = { ...defaultOptions, ...options };

            if (this.options.clickAwayToClose) droppies.push(this);
        }

        show() {
            if (this.options.animationIn) {
                this.drop.addEventListener('animationend', () => {
                    this.drop.classList.remove(this.options.animationIn);
                }, { once: true });

                this.drop.classList.add(this.options.animationIn);
            }

            this.drop.style.display = this.options.display;
        };

        hide() {
            this.drop.addEventListener('animationend', () => {
                this.drop.style.display = 'none';

                if (this.options.animationOut) {
                    this.drop.classList.remove(this.options.animationOut);
                }
            }, { once: true });

            this.options.animationOut
                ? this.drop.classList.add(this.options.animationOut)
                : this.drop.dispatchEvent(new Event('animationend'));
        };

        toggle() {
            this.drop.checkVisibility() ? this.hide() : this.show();
        }
    }

    const droppyRoots = document.querySelectorAll('[data-droppy]');

    droppyRoots.forEach((root) => {
        const options = JSON.parse(root.dataset.droppy);

        const nodes = root.querySelectorAll(options.wrapper);

        nodes.forEach((node) => new Droppy(
            node.querySelector(options.trigger),
            node.querySelector(options.drop),
            options
        ));
    })
</script>
</body>
</html>